Sub ParseXMLWithDynamicHeaders()
  ' This code downloads an Alma Analytics report using REST API. Since it's a VBA code, you can use it in Microsoft applications like Excel and Power BI
  Dim http As Object
  'XML
  Dim xmlDoc As Object
  Dim schemaNode As Object
  Dim elementNodes As Object
  Dim rowNodes As Object
  Dim rowNode As Object
  Dim nodeBook As Object
  Dim attributeID As Object
  Dim attributeName As Object

  Dim headerName As String
  '
  Dim ws As Worksheet
  '
  Dim rows As Object
  Dim row As Object
  Dim childnode As Object
  Dim ChildNodesCounter As Integer
  Dim cellrow As Integer, cnt As Integer

 
  With ThisWorkbook.Sheets(1)
    ' Set the target worksheet and clean contents before starting
    Set ws = ThisWorkbook.Sheets(1)
    ws.Cells.ClearContents
    
    ' Get HTTP request
    ' Define the URL
    url = "https:{Your Analytics URL}?path={Your report path}&limit=25&col_names=true&apikey={Your API key}"
    ' Create HTTP request
    Set http = CreateObject("MSXML2.XMLHTTP")
    http.Open "GET", url, False
    http.Send

    If http.Status <> 200 Then
        MsgBox "Failed to download XML. Status: " & http.Status
        Exit Sub
    End If

    ' Load XML from response
    Set xmlDoc = CreateObject("MSXML2.DOMDocument.6.0")
    xmlDoc.async = False
    xmlDoc.LoadXML http.responseText

    If xmlDoc.ParseError.ErrorCode <> 0 Then
        MsgBox "Error in XML file: " & xmlDoc.ParseError.Reason
        Exit Sub
    End If

    ' Get Column Headers
    Set schemaNode = xmlDoc.SelectSingleNode("//*[local-name()='schema']/*[local-name()='complexType']/*[local-name()='sequence']")
    Set elementNodes = schemaNode.SelectNodes("*[local-name()='element']")
    '
    For Each nodeBook In elementNodes
        If Not attributeID Is Nothing Then
            'columnHeading is found
            Set attributeID = nodeBook.Attributes.getNamedItem("saw-sql:columnHeading")
        Else
            'If columnHeading is not found, use name instead
            Set attributeID = nodeBook.Attributes.getNamedItem("name")
        End If
        ' Fill column headings
        ws.Cells(1, cnt + 1).Value = attributeID.NodeValue
        cnt = cnt + 1
    Next nodeBook

    ' Fill rows
    ' Extract <Row> elements (namespace-aware)
    Set rows = xmlDoc.SelectNodes("//*[local-name()='Row']")
    
    If rows Is Nothing Or rows.Length = 0 Then
        MsgBox "No <Row> elements found."
        Exit Sub
    End If
    ' Loop through rows and write data
    cellrow = 2
    For Each row In rows
        For ChildNodesCounter = 0 To row.ChildNodes.Length - 1
            ws.Cells(cellrow, ChildNodesCounter + 1).Value = row.ChildNodes(ChildNodesCounter).Text
        Next ChildNodesCounter
        cellrow = cellrow + 1
    Next row


  End With

End Sub


